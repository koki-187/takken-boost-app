# 宅建試験対策質問プロンプトシステム 実装ガイド

**作成者**: Manus AI  
**作成日**: 2025年8月15日  
**対象**: システム管理者・開発者

## 概要

本ガイドは、宅地建物取引士試験合格のための毎日の質問プロンプトシステムを既存のPWAアプリ（https://lkebcslv.manus.space/）に実装するための手順書です。

## 実装手順

### 1. データベースの準備

#### 1.1 データベース作成
```sql
-- データベース作成
CREATE DATABASE takken_study_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE takken_study_system;

-- 提供されたスキーマを使用してテーブル作成
-- （takken_question_database.mdの「実装用データ構造」セクション参照）
```

#### 1.2 初期データ投入
```bash
# CSVファイルからデータを投入
mysql -u username -p takken_study_system < import_questions.sql

# または、CSVファイルを直接インポート
LOAD DATA INFILE '/path/to/takken_questions.csv'
INTO TABLE questions
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;
```

### 2. APIエンドポイントの実装

#### 2.1 Node.js/Express.js サーバーの設定
```javascript
// server.js
const express = require('express');
const mysql = require('mysql2/promise');
const cors = require('cors');

const app = express();
app.use(cors());
app.use(express.json());

// データベース接続設定
const dbConfig = {
    host: 'localhost',
    user: 'your_username',
    password: 'your_password',
    database: 'takken_study_system'
};

// 問題取得API
app.get('/api/questions/:timeSlot', async (req, res) => {
    try {
        const { timeSlot } = req.params;
        const { userId, difficulty } = req.query;
        
        // 適応的問題選択ロジックを実装
        const questions = await selectQuestions(timeSlot, userId, difficulty);
        
        res.json({
            status: 'success',
            data: {
                timeSlot,
                questions,
                metadata: {
                    totalQuestions: questions.length,
                    estimatedTotalTime: questions.reduce((sum, q) => sum + q.estimatedTime, 0)
                }
            }
        });
    } catch (error) {
        res.status(500).json({ status: 'error', message: error.message });
    }
});

// 解答送信API
app.post('/api/answers', async (req, res) => {
    try {
        const { userId, questionId, userAnswer, timeSlot } = req.body;
        
        // 解答処理と結果返却
        const result = await processAnswer(userId, questionId, userAnswer, timeSlot);
        
        res.json({
            status: 'success',
            data: result
        });
    } catch (error) {
        res.status(500).json({ status: 'error', message: error.message });
    }
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});
```

### 3. フロントエンド統合

#### 3.1 既存PWAアプリの修正
```javascript
// 既存のapp.jsに追加
class TakkenStudySystem {
    constructor() {
        this.apiBase = '/api';
        this.currentSession = null;
    }
    
    // 学習セッション開始
    async startStudySession(timeSlot) {
        try {
            const response = await fetch(`${this.apiBase}/questions/${timeSlot}?userId=${this.getUserId()}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                this.currentSession = {
                    timeSlot,
                    questions: data.data.questions,
                    currentIndex: 0,
                    startTime: new Date()
                };
                
                this.displayQuestion(this.currentSession.questions[0]);
            }
        } catch (error) {
            console.error('Failed to start study session:', error);
        }
    }
    
    // 問題表示
    displayQuestion(question) {
        const container = document.getElementById('question-container');
        container.innerHTML = `
            <div class="question-header">
                <h3>${question.category} - ${question.difficulty}</h3>
                <div class="progress">${this.currentSession.currentIndex + 1} / ${this.currentSession.questions.length}</div>
            </div>
            <div class="question-text">${question.questionText}</div>
            <div class="options">
                ${question.options.map((option, index) => `
                    <button class="option-btn" data-option="${index + 1}">
                        ${index + 1}. ${option}
                    </button>
                `).join('')}
            </div>
            <div class="learning-points">
                <h4>学習ポイント:</h4>
                <ul>
                    ${question.learningPoints.map(point => `<li>${point}</li>`).join('')}
                </ul>
            </div>
            <div class="tips">
                <strong>ヒント:</strong> ${question.tips}
            </div>
        `;
        
        // オプションボタンのイベントリスナー
        container.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.submitAnswer(question.id, parseInt(e.target.dataset.option));
            });
        });
    }
    
    // 解答送信
    async submitAnswer(questionId, userAnswer) {
        try {
            const response = await fetch(`${this.apiBase}/answers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: this.getUserId(),
                    questionId,
                    userAnswer,
                    timeSlot: this.currentSession.timeSlot
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                this.showResult(result.data);
            }
        } catch (error) {
            console.error('Failed to submit answer:', error);
        }
    }
    
    // 結果表示
    showResult(result) {
        const container = document.getElementById('result-container');
        container.innerHTML = `
            <div class="result ${result.isCorrect ? 'correct' : 'incorrect'}">
                <h3>${result.isCorrect ? '正解！' : '不正解'}</h3>
                <p>正解: ${result.correctAnswer}</p>
                <div class="explanation">${result.explanation}</div>
                <div class="feedback">${result.feedback.message}</div>
                <button id="next-question" class="btn-primary">次の問題へ</button>
            </div>
        `;
        
        document.getElementById('next-question').addEventListener('click', () => {
            this.nextQuestion();
        });
    }
    
    // 次の問題へ
    nextQuestion() {
        this.currentSession.currentIndex++;
        
        if (this.currentSession.currentIndex < this.currentSession.questions.length) {
            this.displayQuestion(this.currentSession.questions[this.currentSession.currentIndex]);
        } else {
            this.endSession();
        }
    }
    
    // セッション終了
    endSession() {
        // セッション結果の表示
        const container = document.getElementById('session-result');
        container.innerHTML = `
            <div class="session-complete">
                <h2>学習セッション完了！</h2>
                <p>お疲れ様でした。今日の学習を振り返ってみましょう。</p>
                <button onclick="location.reload()" class="btn-primary">ホームに戻る</button>
            </div>
        `;
    }
    
    // ユーザーID取得（実装に応じて調整）
    getUserId() {
        return localStorage.getItem('userId') || 'anonymous';
    }
}

// システム初期化
const studySystem = new TakkenStudySystem();

// 時間帯別学習ボタンのイベントリスナー
document.getElementById('morning-study').addEventListener('click', () => {
    studySystem.startStudySession('morning');
});

document.getElementById('afternoon-study').addEventListener('click', () => {
    studySystem.startStudySession('afternoon');
});

document.getElementById('evening-study').addEventListener('click', () => {
    studySystem.startStudySession('evening');
});
```

### 4. プッシュ通知の実装

#### 4.1 Service Worker設定
```javascript
// sw.js
self.addEventListener('push', function(event) {
    const options = {
        body: event.data.text(),
        icon: '/icon-192x192.png',
        badge: '/badge-72x72.png',
        tag: 'study-reminder',
        requireInteraction: true,
        actions: [
            {
                action: 'study',
                title: '学習を始める'
            },
            {
                action: 'later',
                title: '後で'
            }
        ]
    };
    
    event.waitUntil(
        self.registration.showNotification('宅建士試験対策', options)
    );
});

self.addEventListener('notificationclick', function(event) {
    event.notification.close();
    
    if (event.action === 'study') {
        event.waitUntil(
            clients.openWindow('/')
        );
    }
});
```

#### 4.2 通知スケジューラー
```javascript
// notification-scheduler.js
class NotificationScheduler {
    constructor() {
        this.studyTimes = [
            { time: '10:00', message: '🌅 朝の学習時間です！基礎固めを始めましょう' },
            { time: '15:00', message: '☀️ 昼の学習時間です！理解を深めましょう' },
            { time: '19:00', message: '🌙 夜の学習時間です！実戦演習で力を試しましょう' }
        ];
    }
    
    async requestPermission() {
        if ('Notification' in window && 'serviceWorker' in navigator) {
            const permission = await Notification.requestPermission();
            return permission === 'granted';
        }
        return false;
    }
    
    scheduleNotifications() {
        this.studyTimes.forEach(({ time, message }) => {
            this.scheduleNotification(time, message);
        });
    }
    
    scheduleNotification(time, message) {
        const [hours, minutes] = time.split(':').map(Number);
        const now = new Date();
        const scheduledTime = new Date();
        scheduledTime.setHours(hours, minutes, 0, 0);
        
        if (scheduledTime <= now) {
            scheduledTime.setDate(scheduledTime.getDate() + 1);
        }
        
        const timeUntilNotification = scheduledTime.getTime() - now.getTime();
        
        setTimeout(() => {
            this.showNotification(message);
            this.scheduleNotification(time, message); // 翌日の通知も設定
        }, timeUntilNotification);
    }
    
    showNotification(message) {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification('宅建士試験対策', {
                    body: message,
                    icon: '/icon-192x192.png',
                    badge: '/badge-72x72.png',
                    tag: 'study-reminder'
                });
            });
        }
    }
}

// 通知スケジューラーの初期化
const notificationScheduler = new NotificationScheduler();
notificationScheduler.requestPermission().then(granted => {
    if (granted) {
        notificationScheduler.scheduleNotifications();
    }
});
```

### 5. デプロイメント

#### 5.1 本番環境設定
```bash
# 依存関係のインストール
npm install express mysql2 cors

# 環境変数設定
export DB_HOST=your_db_host
export DB_USER=your_db_user
export DB_PASSWORD=your_db_password
export DB_NAME=takken_study_system

# サーバー起動
npm start
```

#### 5.2 HTTPS設定（必須）
```nginx
# nginx設定例
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 運用・保守

### 1. データベースメンテナンス
- 定期的な問題データの更新
- 学習履歴の分析とレポート生成
- パフォーマンス監視

### 2. 問題データの追加
```sql
-- 新しい問題の追加例
INSERT INTO questions (
    id, subject, category, difficulty, time_slot,
    question_text, option_1, option_2, option_3, option_4,
    correct_answer, explanation, learning_points, tips, estimated_time
) VALUES (
    'R005', 'rights', '契約', 'standard', 'afternoon',
    '契約に関する次の記述のうち...',
    '選択肢1', '選択肢2', '選択肢3', '選択肢4',
    2, '解説文', '["学習ポイント1", "学習ポイント2"]', 'ヒント', 240
);
```

### 3. 統計・分析
```sql
-- ユーザー別正答率
SELECT 
    user_id,
    COUNT(*) as total_questions,
    SUM(CASE WHEN is_correct THEN 1 ELSE 0 END) as correct_answers,
    ROUND(SUM(CASE WHEN is_correct THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as accuracy_rate
FROM learning_history
GROUP BY user_id
ORDER BY accuracy_rate DESC;

-- 科目別難易度分析
SELECT 
    q.subject,
    q.difficulty,
    COUNT(*) as total_attempts,
    SUM(CASE WHEN lh.is_correct THEN 1 ELSE 0 END) as correct_attempts,
    ROUND(SUM(CASE WHEN lh.is_correct THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as accuracy_rate
FROM questions q
JOIN learning_history lh ON q.id = lh.question_id
GROUP BY q.subject, q.difficulty
ORDER BY q.subject, q.difficulty;
```

## トラブルシューティング

### よくある問題と解決方法

1. **通知が表示されない**
   - HTTPS環境で動作しているか確認
   - ブラウザの通知許可設定を確認
   - Service Workerの登録状況を確認

2. **問題が表示されない**
   - データベース接続を確認
   - APIエンドポイントの動作を確認
   - ブラウザのコンソールエラーを確認

3. **学習進捗が保存されない**
   - ユーザーIDの設定を確認
   - データベースの書き込み権限を確認
   - APIの解答送信処理を確認

このガイドに従って実装することで、効果的な宅建試験対策システムを構築できます。

